
require_once "connection.php";

class exportData_DAL {

    private $conn;

    function __construct() {
        $dal = new connection();
        $this->conn = $dal->getConn();
    }

    function exportSelected($numerosMecanograficos) {
        if (empty($numerosMecanograficos)) {
            echo "Nenhum funcionário selecionado.";
            return;
        }

        // Cria placeholders para o IN (...)
        $placeholders = implode(',', array_fill(0, count($numerosMecanograficos), '?'));

        $query = "
            SELECT f.*, dl.*, ca.*, dc.*, dp.*, ic.*, df.*, cv.*, b.*
            FROM funcionario f
            LEFT JOIN dadosLogin dl ON f.numeroMecanografico = dl.numeroMecanografico
            LEFT JOIN cargo ca ON dl.idCargo = ca.idCargo
            LEFT JOIN dadosContrato dc ON f.idDadosContrato = dc.idDadosContrato
            LEFT JOIN dadosPessoais dp ON f.idDadosPessoais = dp.idDadosPessoais
            LEFT JOIN indicativocontacto ic ON dp.idIndicativo = ic.idIndicativo
            LEFT JOIN dadosFinanceiros df ON f.idDadosFinanceiros = df.idDadosFinanceiros
            LEFT JOIN cv cv ON f.idCV = cv.idCV
            LEFT JOIN beneficios b ON f.idBeneficios = b.idBeneficios
            WHERE f.numeroMecanografico IN ($placeholders)
        ";

        $stmt = $this->conn->prepare($query);
        
        // Define tipos dinâmicos (tudo "i" porque é int)
        $types = str_repeat('i', count($numerosMecanograficos));
        $stmt->bind_param($types, ...$numerosMecanograficos);

        $stmt->execute();
        $result = $stmt->get_result();

        // CSV
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=funcionarios_selecionados.csv');
        echo "\xEF\xBB\xBF";

        $output = fopen('php://output', 'w');
        $headersWritten = false;

        while ($row = $result->fetch_assoc()) {
            if (!$headersWritten) {
                fputcsv($output, array_keys($row), ';');
                $headersWritten = true;
            }
            fputcsv($output, array_values($row), ';');
        }

        fclose($output);
        $stmt->close();
        exit();
    }


    /* function exportData($filter = 'all') {
        $query = "
            SELECT f.*, dl.*,ca.*,e.*, dc.*, dp.*,ic.*, df.*, cv.*, b.*, v.*
            FROM funcionario f
            LEFT JOIN dadosLogin dl ON f.numeroMecanografico = dl.numeroMecanografico
            LEFT JOIN cargo ca ON dl.idCargo = ca.idCargo
            LEFT JOIN dadosContrato dc ON f.idDadosContrato = dc.idDadosContrato
            LEFT JOIN dadosPessoais dp ON f.idDadosPessoais = dp.idDadosPessoais
            LEFT JOIN indicativocontacto ic ON dp.idIndicativo = ic.idIndicativo
            LEFT JOIN dadosFinanceiros df ON f.idDadosFinanceiros = df.idDadosFinanceiros
            LEFT JOIN cv cv ON f.idCV = cv.idCV
            LEFT JOIN (
                SELECT idColaborador AS idFuncionarioEquipa, idEquipa FROM colaborador_equipa
                UNION
                SELECT idCoordenador AS idFuncionarioEquipa, idEquipa FROM coordenador_equipa
            ) AS equipes ON f.idFuncionario = equipes.idFuncionarioEquipa
            LEFT JOIN equipa e ON e.idEquipa = equipes.idEquipa
            LEFT JOIN beneficios b ON f.idBeneficios = b.idBeneficios
            LEFT JOIN voucher v ON b.idVoucher = v.idVoucher
        ";

        $params = [];
        $param_types = '';
        if ($filter === 'perfil' && isset($_GET['numeroMecanografico'])) {
            $numeroMecanografico = intval($_GET['numeroMecanografico']);
            $query .= " WHERE dl.numeroMecanografico = ?";
            $param_types = 'i';
            $params[] = $numeroMecanografico;
        }
        elseif ($filter === 'colaboradores') {
            $query .= " WHERE dl.idCargo = 2";
        } elseif ($filter === 'equipa' && isset($_GET['idEquipa'])) {
            $idEquipa = intval($_GET['idEquipa']);
            $query .= "
                LEFT JOIN colaborador_equipa ce ON f.idFuncionario = ce.idColaborador AND ce.idEquipa = ?
                LEFT JOIN coordenador_equipa coe ON f.idFuncionario = coe.idCoordenador AND coe.idEquipa = ?
                WHERE ce.idEquipa IS NOT NULL OR coe.idEquipa IS NOT NULL
            ";
            $param_types = 'ii';
            $params[] = $idEquipa;
            $params[] = $idEquipa;
        }


        $stmt = $this->conn->prepare($query);

        if ($param_types) {
            $stmt->bind_param($param_types, ...$params);
        }

        $stmt->execute();
        $result = $stmt->get_result();

        // Set CSV headers - must be before any output
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=colaborador_export.csv');

        // UTF-8 BOM for Excel
        echo "\xEF\xBB\xBF";

        $output = fopen('php://output', 'w');

        $headersWritten = false;
        while ($row = $result->fetch_assoc()) {
            if (!$headersWritten) {
                fputcsv($output, array_keys($row), ';');
                $headersWritten = true;
            }
            fputcsv($output, array_values($row), ';');
        }

        fclose($output);
        $stmt->close();
        exit();
    } */

  function exportData($filter = 'all') {
    $params = [];
    $param_types = '';

    // CASO 1: FILTRO POR EQUIPA
    if ($filter === 'equipa' && isset($_GET['idEquipa'])) {
        $idEquipa = intval($_GET['idEquipa']);

        $query = "
            SELECT 
                f.*, dl.*, ca.*, dc.*, dp.*, ic.*, df.*, cv.*, b.*, v.*,
                ? AS idEquipa
            FROM funcionario f
            LEFT JOIN dadosLogin dl ON f.numeroMecanografico = dl.numeroMecanografico
            LEFT JOIN cargo ca ON dl.idCargo = ca.idCargo
            LEFT JOIN dadosContrato dc ON f.idDadosContrato = dc.idDadosContrato
            LEFT JOIN dadosPessoais dp ON f.idDadosPessoais = dp.idDadosPessoais
            LEFT JOIN indicativocontacto ic ON dp.idIndicativo = ic.idIndicativo
            LEFT JOIN dadosFinanceiros df ON f.idDadosFinanceiros = df.idDadosFinanceiros
            LEFT JOIN cv cv ON f.idCV = cv.idCV
            LEFT JOIN beneficios b ON f.idBeneficios = b.idBeneficios
            LEFT JOIN voucher v ON b.idVoucher = v.idVoucher
            WHERE f.idFuncionario IN (
                SELECT idColaborador FROM colaborador_equipa WHERE idEquipa = ?
                UNION
                SELECT idCoordenador FROM coordenador_equipa WHERE idEquipa = ?
            )
        ";

        $param_types = 'iii';
        $params = [$idEquipa, $idEquipa, $idEquipa];
    }

    // CASO 2: OUTROS FILTROS (perfil, colaboradores, all)
    else {
        $query = "
            SELECT f.*, dl.*, ca.*, dc.*, dp.*, ic.*, df.*, cv.*, b.*, v.*, e.idEquipa
            FROM funcionario f
            LEFT JOIN dadosLogin dl ON f.numeroMecanografico = dl.numeroMecanografico
            LEFT JOIN cargo ca ON dl.idCargo = ca.idCargo
            LEFT JOIN dadosContrato dc ON f.idDadosContrato = dc.idDadosContrato
            LEFT JOIN dadosPessoais dp ON f.idDadosPessoais = dp.idDadosPessoais
            LEFT JOIN indicativocontacto ic ON dp.idIndicativo = ic.idIndicativo
            LEFT JOIN dadosFinanceiros df ON f.idDadosFinanceiros = df.idDadosFinanceiros
            LEFT JOIN cv cv ON f.idCV = cv.idCV
            LEFT JOIN beneficios b ON f.idBeneficios = b.idBeneficios
            LEFT JOIN voucher v ON b.idVoucher = v.idVoucher
            LEFT JOIN (
                SELECT idColaborador AS idFuncionarioEquipa, idEquipa FROM colaborador_equipa
                UNION
                SELECT idCoordenador AS idFuncionarioEquipa, idEquipa FROM coordenador_equipa
            ) AS equipes ON f.idFuncionario = equipes.idFuncionarioEquipa
            LEFT JOIN equipa e ON e.idEquipa = equipes.idEquipa
        ";

        if ($filter === 'perfil' && isset($_GET['numeroMecanografico'])) {
            $numeroMecanografico = intval($_GET['numeroMecanografico']);
            $query .= " WHERE dl.numeroMecanografico = ?";
            $param_types = 'i';
            $params[] = $numeroMecanografico;
        }
        elseif ($filter === 'colaboradores') {
            $query .= " WHERE dl.idCargo = 2";
        }
    }

    // EXECUÇÃO DO PREPARED STATEMENT
    $stmt = $this->conn->prepare($query);

    if ($param_types) {
        $stmt->bind_param($param_types, ...$params);
    }

    $stmt->execute();
    $result = $stmt->get_result();

    // EXPORTAÇÃO CSV
    header('Content-Type: text/csv; charset=utf-8');
    header('Content-Disposition: attachment; filename=colaborador_export.csv');
    echo "\xEF\xBB\xBF"; // BOM para UTF-8

    $output = fopen('php://output', 'w');

    $headersWritten = false;
    while ($row = $result->fetch_assoc()) {
        if (!$headersWritten) {
            fputcsv($output, array_keys($row), ';');
            $headersWritten = true;
        }
        fputcsv($output, array_values($row), ';');
    }

    fclose($output);
    $stmt->close();
    exit();
}




        /// ESTA A APARECER ALGUM ERRO SOBRE O IDCARGO PROBLEMA A IMPORTAR DATAS
    /*function importCSV($csvFilePath) {
    if (($handle = fopen($csvFilePath, 'r')) !== FALSE) {
        $headers = fgetcsv($handle, 1000, ';');

        while (($data = fgetcsv($handle, 1000, ';')) !== FALSE) {
            $row = array_combine($headers, $data);

            //insert no dadoslogin
            $stmt1 = $this->conn->prepare("
                INSERT INTO dadoslogin (numeroMecanografico, password, idCargo )
                VALUES (?, ?, ?)
                ON DUPLICATE KEY UPDATE password = VALUES(password), idCargo = VALUES(idCargo)
            ");
            $stmt1->bind_param("isi", 
                $row['numeroMecanografico'], $row['password'], $row['idCargo']
            );
            $stmt1->execute();
            $stmt1->close();


            // Insert into dadosContrato
            $stmt2 = $this->conn->prepare("
                INSERT INTO dadoscontrato (idDadosContrato, dataInicioDeContrato, dataFimDeContrato, tipoDeContrato,
                regimeDeHorarioDeTrabalho)
                VALUES (?, ?, ?, ?, ? ) 
                ON DUPLICATE KEY UPDATE dataInicioDeContrato = VALUES(dataInicioDeContrato), dataFimDeContrato = VALUES(dataFimDeContrato), 
                tipoDeContrato = VALUES(tipoDeContrato), regimeDeHorarioDeTrabalho = VALUES(regimeDeHorarioDeTrabalho)
            ");
            $stmt2->bind_param("issss", 
                $row['idDadosContrato'], $row['dataInicioDeContrato'], $row['dataFimDeContrato'], $row['tipoDeContrato'],
                $row['regimeDeHorarioDeTrabalho']
            );
            $stmt2->execute();
            $stmt2->close();


            // Insert into dadosPessoais
            $stmt3 = $this->conn->prepare("
                INSERT INTO dadospessoais (idDadosPessoais, nomeCompleto, nomeAbreviado, dataNascimento,
                moradaFiscal,cc, dataValidade, nif, niss, genero, idIndicativo, contactoPessoal, 
                contactoEmergencia, grauDeRelacionamento,email, idNacionalidade )
                VALUES (?,?,?, ?, ?, ?, ?, ?,?,?,?,?,?,?,?,? ) 
                ON DUPLICATE KEY UPDATE nomeCompleto = VALUES(nomeCompleto), nomeAbreviado = VALUES(nomeAbreviado), 
                dataNascimento = VALUES(dataNascimento), moradaFiscal = VALUES(moradaFiscal),
                cc = VALUES(cc), dataValidade = VALUES(dataValidade), nif = VALUES(nif), niss = VALUES(niss),
                genero = VALUES(genero), idIndicativo = VALUES(idIndicativo),
                contactoPessoal = VALUES(contactoPessoal), contactoEmergencia = VALUES(contactoEmergencia), grauDeRelacionamento = VALUES(grauDeRelacionamento),
                 email = VALUES(email), idNacionalidade = VALUES(idNacionalidade)
            ");
            $stmt3->bind_param("isssssssssissssi", 
                $row['idDadosPessoais'], $row['nomeCompleto'], $row['nomeAbreviado'], $row['dataNascimento'],
                $row['moradaFiscal'], $row['cc'], $row['dataValidade'], $row['nif'], $row['niss'],
                $row['genero'],$row['idIndicativo'], $row['contactoPessoal'], $row['contactoEmergencia'], $row['grauDeRelacionamento'],
                $row['email'],$row['idNacionalidade']
            );
            $stmt3->execute();
            $stmt3->close();


            // Insert into dadosFinanceiros
            $stmt4 = $this->conn->prepare("
                INSERT INTO dadosfinanceiros (idDadosFinanceiros, situacaoDeIrs, remuneracao, numeroDeDependentes,
                IBAN)
                VALUES (?,?,?,?,?) 
                ON DUPLICATE KEY UPDATE situacaoDeIrs = VALUES(situacaoDeIRS), remuneracao = VALUES(remuneracao), 
                numeroDeDependentes = VALUES(numeroDeDependentes), IBAN = VALUES(IBAN)
            ");
            $stmt4->bind_param("isdis", 
                $row['idDadosFinanceiros'], $row['situacaoDeIRS'], $row['remuneracao'], $row['numeroDeDependentes'],
                $row['IBAN']
            );
            $stmt4->execute();
            $stmt4->close();


            // Insert into cv
            $stmt5 = $this->conn->prepare("
                INSERT INTO cv (idCV, habilitacoesLiterarias, curso, frequencia)
                VALUES (?,?,?,?)
                ON DUPLICATE KEY UPDATE habilitacoesLiterarias = VALUES(habilitacoesLiterarias), curso = VALUES(curso), 
                frequencia = VALUES(frequencia)
            ");
            $stmt5->bind_param("isss", 
                $row['idCV'], $row['habilitacoesLiterarias'], $row['curso'], $row['frequencia']
            );
            $stmt5->execute();
            $stmt5->close();


             /* // Insert into beneficios
            $stmt6 = $this->conn->prepare("
                INSERT INTO beneficios (idBeneficios, cartaoContinente, idVoucher)
                VALUES (?,?,?) 
                ON DUPLICATE KEY UPDATE cartaoContinente = VALUES(cartaoContinente), idVoucher = VALUES(idVoucher)
            ");
            $stmt6->bind_param("iis", 
                $row['idBeneficios'], $row['cartaoContinente'], $row['idVoucher']
            );
            $stmt6->execute();
            $stmt6->close(); */
           /* $this->inserirOuAtualizarBeneficio($row);



            /* // Insert into funcionario (after related IDs have been inserted)
            $stmtMain = $this->conn->prepare("
                INSERT INTO funcionario (
                    idFuncionario ,numeroMecanografico, idDadosContrato, idDadosPessoais, idDadosFinanceiros, idCV, idBeneficios, estadoFuncionario, dataUltimaAtualizacao
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?,?)
                ON DUPLICATE KEY UPDATE 
                    numeroMecanografico = VALUES(numeroMecanografico),
                    idDadosPessoais = VALUES(idDadosPessoais),
                    idDadosContrato = VALUES(idDadosContrato),
                    idDadosFinanceiros = VALUES(idDadosFinanceiros),
                    idCV = VALUES(idCV),
                    idBeneficios = VALUES(idBeneficios),
                    estadoFuncionario = VALUES(estadoFuncionario),
                    dataUltimaAtualizacao = VALUES(dataUltimaAtualizacao)
            ");

            $stmtMain->bind_param("iiiiiiiss", 
                $row['idFuncionario'],
                $row['numeroMecanografico'],
                $row['idDadosContrato'],
                $row['idDadosPessoais'],
                $row['idDadosFinanceiros'],
                $row['idCV'],
                $row['idBeneficios'],
                $row['estadoFuncionario'],
                $row['dataUltimaAtualizacao']
            );
            $stmtMain->execute();
            $stmtMain->close();
            
            
            // Assign to team if idCargo is 2 or 3 and idEquipa is present
            if (!empty($row['idEquipa']) && $this->verificarIdEquipa($row['idEquipa'])) {
                $idCargo = (int)$row['idCargo'];

                if ($idCargo === 2) {
                    // Insert into colaborador_equipa
                    $stmtTeam = $this->conn->prepare("
                        INSERT INTO colaborador_equipa (idColaborador, idEquipa)
                        VALUES (?, ?)
                        ON DUPLICATE KEY UPDATE idEquipa = VALUES(idEquipa)
                    ");
                    $stmtTeam->bind_param("ii", $row['idFuncionario'], $row['idEquipa']);
                    $stmtTeam->execute();
                    $stmtTeam->close();

                }  elseif ($idCargo === 3) {
                    // Insert into coordenador_equipa
                    $stmtTeam = $this->conn->prepare("
                        INSERT INTO coordenador_equipa (idCoordenador, idEquipa)
                        VALUES (?, ?)
                        ON DUPLICATE KEY UPDATE idEquipa = VALUES(idEquipa)
                    ");
                    $stmtTeam->bind_param("ii", $row['idFuncionario'], $row['idEquipa']);
                    $stmtTeam->execute();
                    $stmtTeam->close();
                } 
            } */
          /* $stmtFuncionario = $this->conn->prepare("
                INSERT INTO funcionario (
                    numeroMecanografico, idDadosContrato, idDadosPessoais, idDadosFinanceiros, idCV, idBeneficios, estadoFuncionario, dataUltimaAtualizacao
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ON DUPLICATE KEY UPDATE 
                    idDadosContrato = VALUES(idDadosContrato),
                    idDadosPessoais = VALUES(idDadosPessoais),
                    idDadosFinanceiros = VALUES(idDadosFinanceiros),
                    idCV = VALUES(idCV),
                    idBeneficios = VALUES(idBeneficios),
                    estadoFuncionario = VALUES(estadoFuncionario),
                    dataUltimaAtualizacao = VALUES(dataUltimaAtualizacao)
            ");

            $stmtFuncionario->bind_param("iiiiisss",
                $data['numeroMecanografico'],
                $idDadosContrato,
                $idDadosPessoais,
                $idDadosFinanceiros,
                $idCV,
                $idBeneficios,
                $data['estadoFuncionario'],
                $data['dataUltimaAtualizacao']
            );
            $stmtFuncionario->execute();

            $idFuncionario = $stmtFuncionario->insert_id;

            if ($idFuncionario == 0) {
                // Se update, buscar idFuncionario pelo numeroMecanografico
                $query = "SELECT idFuncionario FROM funcionario WHERE numeroMecanografico = ?";
                $stmt = $this->conn->prepare($query);
                $stmt->bind_param("i", $data['numeroMecanografico']);
                $stmt->execute();
                $stmt->bind_result($idFuncionario);
                $stmt->fetch();
                $stmt->close();
            }

            $stmtFuncionario->close();

            // --- INSERIR NA TABELA colaborador_equipa SE NECESSÁRIO ---

            if (!empty($data['idEquipa']) && $this->verificarIdEquipa($data['idEquipa'])) {
                $idCargo = (int)$data['idCargo'];

                if ($idCargo === 2) {
                    $stmtEquipe = $this->conn->prepare("
                        INSERT INTO colaborador_equipa (idColaborador, idEquipa)
                        VALUES (?, ?)
                        ON DUPLICATE KEY UPDATE idEquipa = VALUES(idEquipa)
                    ");
                    $stmtEquipe->bind_param("ii", $idFuncionario, $data['idEquipa']);
                    $stmtEquipe->execute();
                    $stmtEquipe->close();
                }
            }
        }

        fclose($handle);
        header("Location: /LSIS1_Grupo4/UI/visualizarFuncionarios.php");
        exit();  // Adjust path as needed
        } else {
            echo " Failed to open CSV file.";
        }
    }
    */
    function verificarIdEquipa($idEquipa){
        $query = "SELECT 1 FROM equipa WHERE idEquipa = ?";
        $stmt = $this->conn->prepare($query);
        $stmt->bind_param("i", $idEquipa);
        $stmt->execute();
        $stmt->store_result();
        return $stmt->num_rows > 0;
    }
    
    function inserirOuAtualizarBeneficio($row){
        // Tratar idVoucher: se vazio ou não definido, usar null
        $idVoucher = (isset($row['idVoucher']) && $row['idVoucher'] !== '') ? $row['idVoucher'] : null;

        $query = "
            INSERT INTO beneficios ( cartaoContinente, idVoucher)
            VALUES (?, ?)
            ON DUPLICATE KEY UPDATE
                cartaoContinente = VALUES(cartaoContinente),
                idVoucher = VALUES(idVoucher)
        ";

        $stmt = $this->conn->prepare($query);
        if (!$stmt) {
            throw new Exception("Erro na preparação da query: " . $this->conn->error);
        }

        // Bind param — idBeneficios (int), cartaoContinente (string), idVoucher (int|null)
        // Para aceitar null no bind_param, precisamos usar um truque: passar uma variável e ajustar o tipo

        $cartaoContinente = $row['cartaoContinente'];

        // Se idVoucher for null, bind como NULL (usando bind_param, 'i' não aceita null diretamente)
        if ($idVoucher === null) {
            // Bind usando tipo 's' e passar null como NULL do PHP (string null)
            // Mas o ideal é usar bind_param com mysqli_stmt::send_long_data, o que complica.
            // Em vez disso, vamos usar bind_param com tipo 'i' e passar null com bindValue
            // Porém, mysqli não aceita null diretamente, precisamos usar bind_param com 'i' e passar null como null
            
            // Para contornar isso, vamos usar bind_param com 'i' e passar null como NULL no PHP (null literal).
            // PHP mysqli permite isso a partir do PHP 7.1+.

            $stmt->bind_param("si",  $cartaoContinente, $idVoucher);
        } else {
            $idVoucher = (int)$idVoucher;
            $stmt->bind_param("si", $cartaoContinente, $idVoucher);
        }

        if (!$stmt->execute()) {
            throw new Exception("Erro na execução da query: " . $stmt->error);
        }

        $stmt->close();
    }

 


function importCSV($csvFilePath) {
    if (($handle = fopen($csvFilePath, 'r')) !== FALSE) {
        $headers = fgetcsv($handle, 1000, ';');

        while (($data = fgetcsv($handle, 1000, ';')) !== FALSE) {
            $row = array_combine($headers, $data);

            $this->conn->begin_transaction();
            try{

            //==============================================================================
            // 1. Inserir dados pessoais
            $stmt = $this->conn->prepare("SELECT idIndicativo FROM indicativocontacto WHERE indicativo =? ");
            $stmt->bind_param("s", $row["indicativo"]);
            $stmt->execute();
            $result['idIndicativo'] = $stmt->get_result()->fetch_assoc();
            $row['idIndicativo'] = $result ? (int)$result['idIndicativo'] : null;
            $stmt->close();
            
            $stmtN = $this->conn->prepare("SELECT idNacionalidade FROM nacionalidade WHERE nacionalidade =? ");
            $stmtN->bind_param("s", $row["nacionalidade"]);
            $stmtN->execute();
            $result = $stmtN->get_result()->fetch_assoc();
            $row['idNacionalidade'] = $result ? (int)$result['idNacionalidade'] : null;
            
            $stmt1 = $this->conn->prepare("INSERT INTO dadospessoais 
                (nomeCompleto, nomeAbreviado, dataNascimento, moradaFiscal, 
                cc, dataValidade, nif, niss, genero, idIndicativo, 
                contactoPessoal, contactoEmergencia, grauDeRelacionamento, 
                email, idNacionalidade) 
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
            if(!$stmt1) throw new Exception("Erro prepare dadospessoais: " . $this->conn->error);
            
            $stmt1->bind_param("sssssssssissssi",
                $row['nomeCompleto'],
                $row['nomeAbreviado'],
                $row['dataNascimento'],
                $row['moradaFiscal'],
                $row['cc'],
                $row['dataValidadeCC'],
                $row['nif'],
                $row['niss'],
                $row['genero'],
                $row["idIndicativo"],
                $row['contactoPessoal'],
                $row['contactoEmergencia'],
                $row['grauDeRelacionamento'],
                $row['email'],
                $row["idNacionalidade"]
            );
            if(!$stmt1->execute()) throw new Exception("Erro execute dadospessoais: " . $stmt1->error);
            echo "Dados pessoais inseridos com sucesso<br>";
            $idDadosPessoais = $this->conn->insert_id;
            
            // 2. Inserir dados de login
            //$hashedPassword = password_hash($dados['password'], PASSWORD_BCRYPT);
            //por enquanto vou deixar sem hash

            $stmtC = $this->conn->prepare("SELECT idCargo FROM cargo WHERE cargo =? ");
            $stmtC->bind_param("s", $row["cargo"]);
            $stmtC->execute();
            $resultC = $stmtC->get_result()->fetch_assoc();
            $row['idCargo'] = $resultC ? (int)$resultC['idCargo'] : null;
            $stmtC->close();

            $stmt2 = $this->conn->prepare("INSERT INTO dadoslogin 
            (numeroMecanografico, password, idCargo) VALUES (?, ?, ?)");
            if(!$stmt2) throw new Exception("Erro na prepare dadoslogin ". $this->conn->error);
            
            $stmt2->bind_param("isi", 
                $row['numeroMecanografico'], 
                $row["password"], 
                $row["idCargo"]
            );
            if(!$stmt2->execute()) throw new Exception("Erro execute dadoslogin " . $stmt2->error);
            echo "Dados login inseridos com sucesso<br>";
            $idDadosLogin = $row['numeroMecanografico'];


            // 3. Inserir dados do contrato
            $stmt3 = $this->conn->prepare("INSERT INTO dadoscontrato 
            (dataInicioDeContrato, dataFimDeContrato, tipoDeContrato, 
            regimeDeHorarioDeTrabalho) VALUES (?, ?, ?, ?)");
            if(!$stmt3) throw new Exception("Erro na prepare dadoscontacto". $this->conn->error);
            
            $stmt3->bind_param("ssss", 
                $row['dataInicioDeContrato'], 
                $row['dataFimDeContrato'], 
                $row['tipoDeContrato'], 
                $row['regimeDeHorarioDeTrabalho']
            );
            if(!$stmt3->execute()) throw new Exception('Erro execute dados contrato'. $stmt3->error);
            echo "Dados de contrato inseridos com sucesso<br>";
            $idDadosContrato = $this->conn->insert_id;

            
            // 4. Inserir dados financeiros
            $stmt4 = $this->conn->prepare("INSERT INTO dadosfinanceiros 
            (situacaoDeIRS, remuneracao, numeroDeDependentes, IBAN) VALUES (?, ?, ?, ?)");
            if(!$stmt4) throw new Exception("Erro na prepare dadosfinanceiros". $this->conn->error);
            
            $stmt4->bind_param("sdis", 
                $row['situacaoDeIRS'], 
                $row['remuneracao'], 
                $row['numeroDeDependentes'], 
                $row['IBAN']
            );
            if(!$stmt4->execute()) throw new Exception('Erro execute dados financeiros'. $stmt4->error);
            echo "Dados financeiros inseridos com sucesso<br>";
            $idDadosFinanceiros = $this->conn->insert_id;

            /*
            
            $stmt5 = $this->conn->prepare("INSERT INTO beneficios (cartaoContinente, voucherNOS) VALUES (?, ?)");
            if(!$stmt5) throw new Exception("Erro na prepare beneficios". $this->conn->error);
            
            $stmt5->bind_param("ss", 
                $row['cartaoContinente'], 
                $row['voucherNos']
            );
            if(!$stmt5->execute()) throw new Exception('Erro execute beneficios'. $stmt5->error);
            echo "Beneficios inseridos com sucesso<br>";

    */    
            // 5. Inserir benefícios
            $this->inserirOuAtualizarBeneficio($row);
            $idBeneficios = $this->conn->insert_id;
            
            // 7. Inserir CV
            $stmt7 = $this->conn->prepare("INSERT INTO cv 
            (habilitacoesLiterarias, curso, frequencia) VALUES (?, ?, ?)");
            if(!$stmt7) throw new Exception("Erro na prepare execute cv". $this->conn->error);
            
            $stmt7->bind_param("sss", 
                $row['habilitacoesLiterarias'], 
                $row['curso'], 
                $row['frequencia']
            );
            if(!$stmt7->execute()) throw new Exception("Erro execute cv". $stmt7->error);
            echo "cv inserido com sucesso<br>";
            $idCV = $this->conn->insert_id;

            
            // 8. inserir funcionario
            $stmtMain = $this->conn->prepare("INSERT INTO funcionario 
            (numeroMecanografico, idDadosContrato, idDadosPessoais, 
            idDadosFinanceiros, idCV, idBeneficios, 
            estadoFuncionario, dataUltimaAtualizacao) VALUES (?,?,?,?,?,?,?,?)");
            if(!$stmtMain) throw new Exception("Erro na prepare funcionario". $this->conn->error);
        
            $stmtMain->bind_param("iiiiiiss", 
                $row["numeroMecanografico"], 
                $idDadosContrato, 
                $idDadosPessoais, 
                $idDadosFinanceiros,
                $idCV, 
                $idBeneficios,
                $row["estadoFuncionario"],
                $row["dataUltimaAtualizacao"],
            );
            if(!$stmtMain->execute()) throw new Exception("Erro execute funcionario". $stmtMain->error);
            echo "Funcionario inserido com sucesso<br>";
            $idFuncionario = $this->conn->insert_id;
            
            $this->conn->commit();

            } catch (Exception $e) {
                $this->conn->rollback();
                throw new RuntimeException("Erro ao registar funcionário: " . $e->getMessage());
                
            }
        }
        fclose($handle);
        header("Location: /LSIS1_Grupo4/UI/visualizarFuncionarios.php");
        exit();  // Adjust path as needed
    } else {
        echo " Failed to open CSV file.";
    }
        
}
}
